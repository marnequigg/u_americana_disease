---
title: "blast_analysis"
author: "m quigg"
date: "2025-12-01"
output: html_document
---
# Who's infected???
Soooooo, I decided to split into "high" and "low" confidence infections because blast is weird.

high= one or more Blast hits matching the genus of the disease
low= one or more hits matching the family of the of the disease

## Import all of the files
```{r}
####import data####
setwd("C:/Users/mquig/Desktop/DED/Data_analysis/disease")
disease=read.csv("final_all_counts_by_individual.csv", header = T)
coords=read.csv("samples_and_coords.csv", header = F)
year=read.csv("samples_and_year.csv", header = T)
```

## Take a trip to the library
This script is easy, all we need is tidyverse.
```{r, include=FALSE}
####library####
#install.packages("tidyverse")
library(tidyverse)
```

## Quick organization
```{r}
###data organization
coords=coords %>% 
  rename("Sample"=V1) %>% 
  rename("Lat"=V2) %>% 
  rename("Long"=V3)

year=year %>% 
  rename("Sample"=ind) %>% 
  rename("Year"=year)
```

## Time to make a dataframe for GIS!
I want a dataframe with a column with "high", "low", or "uninfected" for each disease per individual. I also want a column for coinfections, so I can map that too. It also needs to have the year each tree was sampled, and the coordinates.

I exported the csv file and mapped it in ArcGIS.
```{r}
###infection status
classified_df <- disease %>%
  mutate(
    DED = case_when(
      Ophiostomataceae >= 1 & Ophiostoma >= 1 & ulmi >= 1 ~ "high",
      Ophiostomataceae >= 1 & ulmi == 0 ~ "low",
      TRUE ~ "uninfected"
    ),
    Phyto = case_when(
      Acholeplasmataceae >= 1 & Phytoplasma >= 1 ~ "high",
      Acholeplasmataceae >= 1 & Phytoplasma == 0 ~ "low",
      TRUE ~ "uninfected"
    ),
    MalS = case_when(
      Leptosphaeriaceae >= 1 & Plenodomus >= 1 ~ "high",
      Leptosphaeriaceae >= 1 & Plenodomus == 0 ~ "low",
      TRUE ~ "uninfected"
    )) %>%
  select(Sample, DED, Phyto, MalS)

###now calculate the number of each infection
sum(classified_df$DED=="high")
num_positive= classified_df %>% 
  summarise(DED_high   = sum(DED == "high"),
            Phyto_high = sum(Phyto == "high"),
            MalS_high  = sum(MalS == "high"), 
            DED_low    = sum(DED == "low"),
            Phyto_low  = sum(Phyto == "low"),
            MalS_low   = sum(MalS == "low"))

###add the coords and year info
for_GIS=left_join(classified_df, coords, by = "Sample")
for_GIS=left_join(for_GIS, year, by = "Sample")
for_GIS=for_GIS %>% 
  filter(!is.na(Lat))
for_GIS
str(for_GIS)

###add the ploidy info
tetras=read.csv("cluster1_4n.csv", header = T)
diploids=read.csv("cluster2_other.csv", header = T)
##add a column that lists the ploidy
tetras=tetras %>% 
  mutate(ploidy="4") %>% 
  rename(Sample = "ind")
diploids=diploids %>% 
  mutate(ploidy="2") %>% 
  rename(Sample = "ind")
##stack the files on top of each other
ploidy=rbind(tetras, diploids)
##combine with the big dataset
for_GIS=left_join(for_GIS, ploidy, by = "Sample")

###remove individuals with unknown ploidy and missing coords
for_GIS=for_GIS %>% 
  na.omit(ploidy)

###make one column with the coinfections
all_infections <- for_GIS %>%
  mutate(
    infection_status = case_when(
      DED %in% c("high", "low") & Phyto %in% c("high", "low") & MalS %in% c("high", "low") ~ "DED/Phytoplasma/MalSecco",
      DED %in% c("high", "low") & Phyto %in% c("high", "low") ~ "DED/Phytoplasma",
      DED %in% c("high", "low") & MalS %in% c("high", "low") ~ "DED/MalSecco",
      Phyto %in% c("high", "low") & MalS %in% c("high", "low") ~ "Phytoplasma/MalSecco",
      DED %in% c("high", "low") ~ "DED",
      Phyto %in% c("high", "low") ~ "Phytoplasma",
      MalS %in% c("high", "low") ~ "MalSecco",
      TRUE ~ "uninfected"
    )
  )

#write.csv(all_infections, "C:/Users/mquig/Desktop/DED/Data_analysis/disease/all_infections_status_final.csv")
```
## Number of Infections
```{r}
###DED
DED_infected=all_infections %>% 
  filter(DED != "uninfected")
nrow(DED_infected)
#57
##make csv for mapping
DED_infected_map=all_infections %>% 
  filter(DED != "uninfected")
#write.csv(DED_infected_map, "C:/Users/mquig/Desktop/DED/Data_analysis/disease/DED_final.csv")

###Phytoplasma
phyto_infected=all_infections %>% 
  filter(Phyto != "uninfected")
nrow(phyto_infected)
#22
##make csv for mapping
phyto_infected_map=all_infections %>% 
  filter(Phyto != "uninfected")
#write.csv(phyto_infected_map, "C:/Users/mquig/Desktop/DED/Data_analysis/disease/phyto_final.csv")

###Mal Secco
malsecco_infected=all_infections %>% 
  filter(MalS != "uninfected")
nrow(malsecco_infected)
#121
##make csv for mapping
mals_infected_map=all_infections %>% 
  filter(MalS != "uninfected")
#write.csv(mals_infected_map, "C:/Users/mquig/Desktop/DED/Data_analysis/disease/malsecco_final.csv")
```
### High vs. low confidence infections
```{r}
###DED
##high
sum(DED_infected$DED=="high")
#3
sum(DED_infected$DED=="low")
#54

##phyto
sum(phyto_infected$Phyto=="high")
#21
sum(phyto_infected$Phyto=="low")
#1

##malsecco
sum(malsecco_infected$MalS=="high")
#116
sum(malsecco_infected$MalS=="low")
#5
```

## Oldest Infections
I want to know the earliest record of infections based on this dataset.
```{r}
###identify oldest infection
##DED
DED_pos=for_GIS %>% 
  filter(DED!="uninfected")
min(DED_pos$Year)
#1903

##phyto
phyto_pos=for_GIS %>% 
  filter(Phyto!="uninfected")
min(phyto_pos$Year)
#1909

##MalS
MalS_pos=for_GIS %>% 
  filter(MalS!="uninfected")
min(MalS_pos$Year)
#1897
```

### Cumulative number of infections over time
```{r}
### cumulative dataframe
cumulative_infect <- all_infections %>%
  mutate(
    DED   = ifelse(DED %in% c("high","low"), 1, 0),
    ElmYellows = ifelse(Phyto %in% c("high","low"), 1, 0),
    MalSecco  = ifelse(MalS %in% c("high","low"), 1, 0),
    Total = 1   # every sample counts toward cumulative total
  )

### convert to long format
cumulative_long <- cumulative_infect %>%
  select(Year, DED, ElmYellows, MalSecco, Total) %>%
  pivot_longer(cols = -Year, names_to = "Disease", values_to = "Infected")

### calculate the infections
cumulative_df <- cumulative_long %>%
  group_by(Disease, Year) %>%
  summarise(count = sum(Infected), .groups = "drop") %>%
  group_by(Disease) %>%
  arrange(Year) %>%
  mutate(cumulative = cumsum(count))

### graph it
ggplot(cumulative_df, aes(x = Year, y = cumulative, color = Disease)) +
  geom_line(size = 1) +
  #geom_point(size = 2) +
  scale_color_manual(values = c("purple4", "cornflowerblue", "springgreen4", "grey70")) +
  xlim(1890, 2025) +
  ylim(0, 550) +
  labs(
    #title = "Cumulative Infections Over Time",
    x = "Year",
    y = "Cumulative Number of Infected Individuals") +
  theme_classic() +
  theme(
    legend.position = c(0.035, 0.95),   # relative coordinates (x, y) inside plot
    legend.justification = c("left", "top"),
    legend.background = element_rect(fill = "white", color = "black") # box around legend
  )
```
###Cumulative percentage of infected individuals over time
So today I presented at the Hipp lab meeting, and there were some concerns with this graph. Which is understandable, I thought the platau was weird too. Now, I'm going to try it again and see if anything changes.
```{r}
all_infections$Year=as.numeric(all_infections$Year)
cumsum_diseases=all_infections %>% 
   mutate(
    DED   = ifelse(DED   %in% c("high","low"), 1, 0),
    ElmYellows = ifelse(Phyto %in% c("high","low"), 1, 0),
    MalSecco  = ifelse(MalS  %in% c("high","low"), 1, 0)) %>% 
  arrange(Year) %>% 
  mutate(num_samples = 1) 

cumsum_diseases2=cumsum_diseases %>% 
  arrange(Year) %>% 
  group_by(Year) %>%
  summarise(
    sum_DED = sum(DED),
    sum_EY  = sum(ElmYellows),
    sum_MalS = sum(MalSecco),
    num_samples = sum(num_samples),
    .groups = "drop")

cumsum_diseases3=cumsum_diseases2 %>% 
  mutate(cumsum_DED=cumsum(sum_DED)) %>% 
  mutate(cumsum_EY=cumsum(sum_EY)) %>% 
  mutate(cumsum_MalS=cumsum(sum_MalS)) %>% 
  mutate(num_samples = cumsum(num_samples)) %>% 
  select(Year, cumsum_DED, cumsum_EY, cumsum_MalS, num_samples)

percent_infect=cumsum_diseases3 %>% 
  mutate(DED=(cumsum_DED/num_samples)*100) %>% 
  mutate(ElmYellows=(cumsum_EY/num_samples)*100) %>% 
  mutate(MalSecco=(cumsum_MalS/num_samples)*100) %>% 
  select(Year, DED, ElmYellows, MalSecco)

percent_graph=percent_infect %>% 
  pivot_longer(
    cols = c(DED, ElmYellows, MalSecco),
    names_to = "Disease",
    values_to = "percent_infected"
  )

ggplot(percent_graph, aes(x = Year, y = percent_infected, color = Disease)) +
    geom_vline(xintercept = c(1930, 1880, 2024), color = c("purple4", "springgreen4", "cornflowerblue"), linetype = "dashed", linewidth = 1) +
  geom_line(linewidth = 1.2) +
  #geom_point(size = 2) +
  labs(
    #title = "Cumulative percentage of infected individuals over time",
    x = "Year of Sample Collection",
    y = "Cumulative percentage of Infected Individuals") +
  theme_classic() +
  #ylim(0, 31) +
  theme(
    legend.position = c(0.05, 0.95),
    legend.justification = c("left", "top"),
    legend.background = element_rect(fill = "white", color = "black")) +
  scale_color_manual(values = c("purple4", "springgreen4", "cornflowerblue"))
```
After showing this graph to some people, they don't like it. Everyone thinks we need to somehow show the number of samples. 

###Stacked bar plot for each disease
The main recommendation was a stacked barplot over time. The years would have to be binned, so that is challenge #1. The other challenge is the coinfections. Jeremie recommended that I do one graph for each disease, then put it in the figure along the maps.

I don't think I'm going to like the outcome, but let's try it.

####DED
```{r}
###make the binned dataframe
binned_20yr <- cumsum_diseases2 %>%
  mutate(
    Year_bin = case_when(
      Year >= 1842 & Year <= 1860 ~ "1842-1860",
      Year >= 1861 & Year <= 1880 ~ "1861-1880",
      Year >= 1881 & Year <= 1900 ~ "1881-1900",
      Year >= 1901 & Year <= 1920 ~ "1901-1920",
      Year >= 1921 & Year <= 1940 ~ "1921-1940",
      Year >= 1941 & Year <= 1960 ~ "1941-1960",
      Year >= 1961 & Year <= 1980 ~ "1961-1980",
      Year >= 1981 & Year <= 2000 ~ "1981-2000",
      Year >= 2000 & Year <= 2020 ~ "2000-2020",
      Year >= 2020 & Year <= 2024 ~ "2020-2024")) %>%
  group_by(Year_bin) %>%
  summarise(
    sum_DED   = sum(sum_DED),
    sum_EY    = sum(sum_EY),
    sum_MalS  = sum(sum_MalS),
    num_samples = sum(num_samples),
    .groups = "drop"
  )

###DED
##make dataframe
DED_binned=binned_20yr %>% 
  mutate(num_uninfected=num_samples - sum_DED) %>% 
  select(Year_bin, sum_DED, num_uninfected) %>% 
  rename(infected=sum_DED) %>% 
  rename(uninfected=num_uninfected) %>% 
  rename(Year=Year_bin)
##pivot longer
DED_binned_long <- DED_binned %>%
  pivot_longer(
    cols = c(uninfected, infected),
    names_to = "Category",
    values_to = "Count")
##plot it
ggplot(DED_binned_long, aes(x = Year, y = Count, fill = Category)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(
    values = c("uninfected" = "grey70", "infected" = "purple4")) +
  labs(
    x = "Year of Sample Collection",
    y = "Number of Samples") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = c(0.05, 0.95),
        legend.justification = c("left", "top"),
        legend.background = element_rect(fill = "white", color = "black"))

###elm yellows
##make dataframe
EY_binned=binned_20yr %>% 
  mutate(num_uninfected=num_samples - sum_EY) %>% 
  select(Year_bin, sum_EY, num_uninfected) %>% 
  rename(infected=sum_EY) %>% 
  rename(uninfected=num_uninfected) %>% 
  rename(Year=Year_bin)
##pivot longer
EY_binned_long <- EY_binned %>%
  pivot_longer(
    cols = c(uninfected, infected),
    names_to = "Category",
    values_to = "Count")
##plot it
ggplot(EY_binned_long, aes(x = Year, y = Count, fill = Category)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(
    values = c("uninfected" = "grey70", "infected" = "springgreen4")) +
  labs(
    x = "Year of Sample Collection",
    y = "Number of Samples") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = c(0.05, 0.95),
        legend.justification = c("left", "top"),
        legend.background = element_rect(fill = "white", color = "black"))

###mal secco
##make dataframe
MalS_binned=binned_20yr %>% 
  mutate(num_uninfected=num_samples - sum_MalS) %>% 
  select(Year_bin, sum_MalS, num_uninfected) %>% 
  rename(infected=sum_MalS) %>% 
  rename(uninfected=num_uninfected) %>% 
  rename(Year=Year_bin)
##pivot longer
MalS_binned_long <- MalS_binned %>%
  pivot_longer(
    cols = c(uninfected, infected),
    names_to = "Category",
    values_to = "Count")
##plot it
ggplot(MalS_binned_long, aes(x = Year, y = Count, fill = Category)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(
    values = c("uninfected" = "grey70", "infected" = "cornflowerblue")) +
  labs(
    x = "Year of Sample Collection",
    y = "Number of Samples") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = c(0.05, 0.95),
        legend.justification = c("left", "top"),
        legend.background = element_rect(fill = "white", color = "black"))
```
I was right... I hate this :)

## Coinfections
Apparently, very little is known about coinfections. I want to check and see if any of these trees are infected with 2+ diseases at once.
```{r}
##DED and phytoplasma
DED_phyto=for_GIS %>% 
  filter(DED!="uninfected") %>% 
  filter(Phyto!="uninfected")
nrow(DED_phyto)
#11 co-infections

##DED and MalS
DED_MalS=for_GIS %>% 
  filter(DED!="uninfected") %>% 
  filter(MalS!="uninfected")
nrow(DED_MalS)
#40 co-infection

##Phyto and MalS
Phyto_MalS=for_GIS %>% 
  filter(MalS!="uninfected") %>% 
  filter(Phyto!="uninfected")
nrow(Phyto_MalS)
#11

##all 3
all_three=for_GIS %>% 
  filter(DED!="uninfected") %>% 
  filter(Phyto!="uninfected") %>% 
  filter(MalS!="unifected")
nrow(all_three)
#11
```
## Incorportate ploidy
I also want to look at how disease is present across each ploidy.
```{r}
###make dataframes for each cytotype
diploid_infections= all_infections %>% 
  filter(ploidy == "2")

polyploid_infections= all_infections %>% 
  filter(ploidy == "4")
```
### Number of infections
```{r}
####diploids
###DED
diploid_DED_infected=diploid_infections %>% 
  filter(DED != "uninfected")
nrow(diploid_DED_infected)
#9
sum(diploid_DED_infected$DED=="high")
sum(diploid_DED_infected$DED=="low")

###phyto
diploid_phyto_infected=diploid_infections %>% 
  filter(Phyto != "uninfected")
nrow(diploid_phyto_infected)
#2
sum(diploid_phyto_infected$Phyto=="high")
sum(diploid_phyto_infected$Phyto=="low")

###mal secco
###DED
diploid_mals_infected=diploid_infections %>% 
  filter(MalS != "uninfected")
nrow(diploid_mals_infected)
#17
sum(diploid_mals_infected$MalS=="high")
sum(diploid_mals_infected$MalS=="low")

```

```{r}
####polyploid
###DED
polyploid_DED_infected=polyploid_infections %>% 
  filter(DED != "uninfected")
nrow(polyploid_DED_infected)
#48
sum(polyploid_DED_infected$DED=="high")
sum(polyploid_DED_infected$DED=="low")

###phyto
polyploid_phyto_infected=polyploid_infections %>% 
  filter(Phyto != "uninfected")
nrow(polyploid_phyto_infected)
#20
sum(polyploid_phyto_infected$Phyto=="high")
sum(polyploid_phyto_infected$Phyto=="low")

###mal secco
###DED
polyploid_mals_infected=polyploid_infections %>% 
  filter(MalS != "uninfected")
nrow(polyploid_mals_infected)
#104
sum(polyploid_mals_infected$MalS=="high")
sum(polyploid_mals_infected$MalS=="low")
```
